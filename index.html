<!DOCTYPE html>
<html>
<head>
  <title>Katraj Zoo Live Map</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <style>
    #map { height: 100vh; width: 100vw; }
    .leaflet-control-zoom { display: none !important; }
  </style>
</head>
<body>
  <div style="position:absolute; top:10px; left:10px; z-index:1000; background:white; padding:10px; border-radius:8px;">
    <label for="animalSelect">Go to Animal:</label>
    <select id="animalSelect">
      <option value="">--Select--</option>
      <option value="Lion">Lion</option>
      <option value="Elephant">Elephant</option>
      <option value="Peacock">Peacock</option>
      <option value="White Tiger">White Tiger</option>
      <option value="Snake">Snake</option>
      <option value="Monkey">Monkey</option>
    </select>
    <button onclick="goToAnimal()">Go</button>
  </div>

  <div id="map"></div>

  <script>
    const map = L.map('map', { zoomControl: false }).setView([18.4515, 73.8655], 17);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 20,
      attribution: '© OpenStreetMap'
    }).addTo(map);

    const animals = {
      "Lion": [18.453692734295167, 73.85899591533487],
      "Elephant": [18.4519, 73.8672],
      "Peacock": [18.4523, 73.8661],
      "White Tiger": [18.4520, 73.8653],
      "Snake": [18.4507, 73.8659],
      "Monkey": [18.4515, 73.8648]
    };

    let userMarker = null;
    let userCoords = null;

    const animalMarkers = {};

    for (const [name, coords] of Object.entries(animals)) {
      const marker = L.marker(coords).addTo(map).bindPopup(`<b>${name}</b><br><button onclick=\"handleAnimalClick('${name}')\">Get Directions</button>`);
      animalMarkers[name] = marker;
    }

    function showUserLocation(latlng) {
      userCoords = latlng;
      if (userMarker) {
        userMarker.setLatLng(latlng);
      } else {
        userMarker = L.marker(latlng, {
          icon: L.icon({
            iconUrl: 'https://cdn-icons-png.flaticon.com/512/64/64113.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [0, -30]
          })
        }).addTo(map).bindPopup("You are here").openPopup();
        map.setView(latlng, 17);
      }
    }

    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        (position) => {
          const latlng = {
            lat: position.coords.latitude,
            lng: position.coords.longitude
          };
          console.log("User location:", latlng);
          showUserLocation(latlng);
        },
        (error) => {
          console.error("Geolocation error:", error);
          alert("Unable to retrieve your location. Please allow location access.");
        },
        {
          enableHighAccuracy: true,
          timeout: 10000,
          maximumAge: 0
        }
      );
    } else {
      alert("Geolocation is not supported by your browser.");
    }

    async function getShortestPath(destination) {
      const response = await fetch('http://localhost:5000/shortest-path', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ start: "User", end: destination })
      });
      const result = await response.json();
      alert("Shortest path:\n" + result.path.join(" → ") + `\nDistance: ${result.distance} m`);
    }

    function goToAnimal() {
      const selected = document.getElementById('animalSelect').value;
      if (selected && animals[selected]) {
        map.setView(animals[selected], 18);
        getShortestPath(selected);
      }
    }

    function handleAnimalClick(animalName) {
      document.getElementById("animalSelect").value = animalName;
      goToAnimal();
    }
  </script>
</body>
</html>
